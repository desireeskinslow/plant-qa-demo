<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Plant Q&A</title>
<style>
  :root{ --bg:#000; --surface:#111; --text:#e7e7e7; --muted:#9aa0a6; --border:#222; --a1:#1e90ff; --a2:#3ea0ff; }
  html,body{margin:0;min-height:100%}
  body{background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  *{box-sizing:border-box}

  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{text-align:center;margin-bottom:14px}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:14px;margin-top:4px}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}

  /* ASK AREA */
  .ask-grid{ display:grid; grid-template-columns:1fr; gap:12px; align-items:start; }
  .ask-grid > textarea{
    width:100%; min-height:120px; background:#000; color:var(--text);
    border:1px solid var(--border); border-radius:10px; padding:12px;
    font-size:16px; line-height:1.5; resize:vertical; min-width:0; max-width:100%;
  }
  .actions{ display:flex; flex-direction:column; gap:8px; width:100%; }
  .btn{
    border:0; border-radius:10px; padding:12px 16px; font-size:15px; font-weight:600; cursor:pointer; color:#fff;
    background:linear-gradient(135deg,var(--a1),var(--a2)); width:100%;
  }
  .btn.ghost{ background:transparent; border:1px solid var(--border); color:var(--text) }

  .grid{ display:grid; gap:12px; margin-top:14px }
  @media(min-width:900px){
    .ask-grid{ grid-template-columns:minmax(0,1fr) 260px; column-gap:12px; }
    .grid{ grid-template-columns:1fr 1fr; }
    .actions{ align-self:start; }
  }

  .head{display:flex;justify-content:space-between;align-items:center}
  .chip{font-size:12px;color:var(--muted)}
  .answer{margin-top:8px;line-height:1.6;white-space:pre-wrap}
  .muted{color:var(--muted)}
  ol{padding-left:20px;margin:8px 0 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸŒ¿ Plant Q&A</h1>
      <div class="sub">Ask about the plants. Side-by-side AI answers.</div>
    </header>

    <div class="card">
      <div class="ask-grid">
        <textarea id="q" placeholder="e.g., which need full sun? or if the low is 45Â°F, which should come inside?"></textarea>
        <div class="actions">
          <button id="askBtn" class="btn">Ask</button>
          <button id="previewBtn" class="btn ghost">Preview plants</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head"><h3>ðŸ§  Gemini</h3><span id="gmTime" class="chip"></span></div>
        <div id="gOut" class="answer muted">â€”</div>
      </div>
      <div class="card">
        <div class="head"><h3>ðŸ§¬ Python LLM</h3><span id="pyTime" class="chip"></span></div>
        <div id="pOut" class="answer muted">â€”</div>
      </div>
    </div>

    <div class="card">
      <div class="head"><h3>Preview</h3></div>
      <div id="previewHead" class="muted">â€”</div>
      <ol id="previewList" class="muted"></ol>
    </div>
  </div>

<script>
/* ====== CONFIG: paste your /exec URL here ====== */
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwE9GbNFgDx_QQVakFbX3uPWIZX2PyBlvLCX13ch67ob4q2jO6ghrRKd2gPjUBJzuU/exec';

/* ====== DOM ====== */
const gOut = document.getElementById('gOut');
const pOut = document.getElementById('pOut');
const gmTime = document.getElementById('gmTime');
const pyTime = document.getElementById('pyTime');
const qEl = document.getElementById('q');
const previewHead = document.getElementById('previewHead');
const previewList = document.getElementById('previewList');

document.getElementById('askBtn').onclick = ask;
document.getElementById('previewBtn').onclick = previewPlants;
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && e.target.id === 'q') { e.preventDefault(); ask(); }
});

/* ====== Helpers ====== */
function renderAnswer(t, el){ el.textContent = t || 'â€”'; el.classList.toggle('muted', !t); }
function startCounter(el){ const t0 = Date.now(); const id = setInterval(()=>{ el.textContent = `â³ ${((Date.now()-t0)/1000).toFixed(1)}s`; }, 200); return {id,t0}; }
function stopCounter(el, tick){ if (tick){ clearInterval(tick.id); el.textContent = `â± ${((Date.now()-tick.t0)/1000).toFixed(1)}s`; } }
function asJsonOrThrow(text, status){
  try { return JSON.parse(text); }
  catch { throw new Error(`Bad JSON (${status}). Check your Web App /exec URL & access.`); }
}

async function api(action, params = {}, { timeoutMs = 30000 } = {}) {
  const qs = new URLSearchParams({ action, ...params }).toString();
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(new Error('timeout')), timeoutMs);
  try {
    const r = await fetch(`${GAS_API_URL}?${qs}`, { method:'GET', cache:'no-store', signal: ctrl.signal });
    const text = await r.text();
    if (!r.ok) throw new Error(`HTTP ${r.status}: ${text.slice(0,160)}`);
    const j = asJsonOrThrow(text, r.status);
    if (j && j.ok === false) throw new Error(j.error || 'API error');
    return j;
  } finally { clearTimeout(timer); }
}

/* ====== Actions ====== */
function ask(){
  const q = qEl.value.trim(); if (!q) return;
  renderAnswer('Thinkingâ€¦', gOut);
  renderAnswer('Thinkingâ€¦', pOut);
  const gt = startCounter(gmTime);
  const pt = startCounter(pyTime);

  api('ask_gemini', { q }, { timeoutMs: 30000 })
    .then(res => renderAnswer(res.answer || '(no answer)', gOut))
    .catch(err => renderAnswer('Gemini error: ' + err.message, gOut))
    .finally(() => stopCounter(gmTime, gt));

  api('ask_python', { q }, { timeoutMs: 45000 })
    .then(res => renderAnswer(res.answer || '(no answer)', pOut))
    .catch(err => renderAnswer('Python error: ' + err.message, pOut))
    .finally(() => stopCounter(pyTime, pt));
}

function previewPlants(){
  previewHead.textContent = 'Loadingâ€¦';
  previewList.innerHTML = '';
  api('preview', {}, { timeoutMs: 15000 })
    .then(o => {
      previewHead.textContent = `Sheet: ${o.sheet} â€¢ ${o.count} plants`;
      previewList.innerHTML = (o.sample || []).map(s => `<li>${s}</li>`).join('');
      previewList.classList.remove('muted');
    })
    .catch(err => {
      previewHead.textContent = 'Error: ' + err.message;
      previewList.innerHTML = '';
    });
}
</script>
</body>
</html>
